<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Practice Listening</title>
    <link rel="stylesheet" th:href="@{/css/listeningTest.css}" />
  </head>
  <body>
    <header class="header">
      <button class="back-btn" onclick="goBack()">‚Üê</button>
    </header>

    <nav class="sidebar">
      <h2>Listening Tests</h2>
      <ul id="test-list">
        <li
          th:each="test : ${tests}"
          th:attr="data-test-id=${test.id}"
          th:text="${test.title}"
          class="test-item"
        ></li>
      </ul>
    </nav>

    <main class="content">
      <div class="listening-container">
        <section class="question">
          <h2 id="question-title"></h2>
          <div class="image-container">
            <img
              id="question-image"
              th:src="@{/images/placeholder.png}"
              alt="Question Image"
            />
          </div>
          <audio id="audio" controls>
            <source src="" type="audio/mpeg" />
            Your browser does not support the audio element.
          </audio>
        </section>

        <section class="answers">
          <form id="quiz-form"></form>
          <button type="button" class="submit-btn" id="submit-btn">
            Submit
          </button>
          <p id="result"></p>
          <div class="navigation">
            <button id="prev-btn">Previous</button>
            <button id="next-btn">Next</button>
          </div>
        </section>
      </div>
    </main>

    <script th:inline="javascript">
            /*<![CDATA[*/
            const tests = [[${tests}]];
            console.log("Tests loaded:", tests);
            let questions = [];
            let currentQuestionIndex = 0;
            let correctCount = 0;
            let incorrectCount = 0;
            let answeredQuestions = {};
            /*]]>*/

                      // Event handling
                      document.addEventListener("DOMContentLoaded", function () {
                        try {
                          initializeListeners();
                          if (tests && tests.length > 0) {
                            loadTest(tests[0].id);
                          }
                        } catch (error) {
                          console.error("Error initializing:", error);
                        }
                      });

                      // Remove window.onload as we're using DOMContentLoaded

                      // Event initialization
                      function initializeListeners() {
                        // Test selection
                        document.querySelectorAll("#test-list li").forEach((item) => {
                          item.addEventListener("click", function () {
                            const testId = parseInt(this.getAttribute("data-test-id"));
                            loadTest(testId);
                          });
                        });

                        // Navigation controls
                        document
                          .getElementById("submit-btn")
                          .addEventListener("click", checkAnswer);
                        document
                          .getElementById("prev-btn")
                          .addEventListener("click", prevQuestion);
                        document
                          .getElementById("next-btn")
                          .addEventListener("click", nextQuestion);
                      }

                      // Resource loading utilities
                      const loadWithRetry = async (url, retries = 3) => {
                        for (let i = 0; i < retries; i++) {
                          try {
                            const response = await fetch(url);
                            if (!response.ok)
                              throw new Error(`HTTP error! status: ${response.status}`);
                            return response;
                          } catch (error) {
                            console.log(`Attempt ${i + 1} failed: ${error.message}`);
                            if (i === retries - 1) throw error;
                            await new Promise((resolve) => setTimeout(resolve, 1000));
                          }
                        }
                      };

                      function loadTest(testId) {
                        try {
                          const test = tests.find((t) => t.id === testId);
                          if (!test) {
                            console.error("Test not found:", testId);
                            return;
                          }

                          questions = test.questions;
                          console.log("Loading test:", test);

                          // Update UI
                          document
                            .querySelectorAll("#test-list li")
                            .forEach((li) => li.classList.remove("selected"));
                          document
                            .querySelector(`li[data-test-id="${testId}"]`)
                            ?.classList.add("selected");

                          currentQuestionIndex = 0;
                          loadQuestion(currentQuestionIndex);
                        } catch (error) {
                          console.error("Error loading test:", error);
                        }
                      }

                      function loadQuestion(index) {
                    if (index < 0 || index >= questions.length) return;

                    const question = questions[index];
                    console.log("Loading question:", question);

                    // Update question title
                    document.getElementById("question-title").textContent =
                        `Question ${index + 1}: ${question.questionText}`;

                    // Load image - Update path construction
                    const imageElement = document.getElementById("question-image");
                    const imagePath = `/images/ListeningTest${question.testId}/Question${question.id}.png`;
                    imageElement.src = imagePath;
                    imageElement.onerror = function() {
                        console.error("Failed to load image:", imagePath);
                        this.src = "/images/placeholder.png";
                    };

                    // Load audio - Update path construction
                    const audioElement = document.getElementById("audio");
                    const audioSource = audioElement.querySelector("source");
                    const audioPath = `/audio/ListeningTest${question.testId}/Question${question.id}.mp3`;
                    audioSource.src = audioPath;
                    audioElement.load();
                    audioElement.onerror = function() {
                        console.error("Failed to load audio:", audioPath);
                    };

                    // Load options
                    const quizForm = document.getElementById("quiz-form");
                    quizForm.innerHTML = "";

                    if (question.options && question.options.length > 0) {
                        question.options.forEach((option) => {
                            console.log("Processing option:", option);
                            const label = document.createElement("label");
                            label.classList.add("answer-option");
                            label.innerHTML = `
                                <input type="radio" name="answer" value="${option.optionLabel}">
                                ${option.optionLabel}. ${option.optionText}
                            `;
                            quizForm.appendChild(label);
                        });
                    } else {
                        console.warn("No options found for question:", question);
                    }

                    // Reset result display
                    document.getElementById("result").textContent = "";

                    // Update navigation
                    updateNavigationButtons();
                }

                      function checkAnswer() {
                        const selected = document.querySelector('input[name="answer"]:checked');
                        if (!selected) {
                          alert("Please select an answer.");
                          return;
                        }

                        const question = questions[currentQuestionIndex];
                        const isCorrect = selected.value === question.correctOptionLabel;

                        const result = document.getElementById("result");
                        if (isCorrect) {
                          result.textContent = "Correct! üéâ";
                          result.style.color = "green";
                          correctCount++;
                        } else {
                          result.textContent = `Incorrect. The correct answer is ${question.correctOptionLabel}`;
                          result.style.color = "red";
                          incorrectCount++;
                        }

                        // Disable options after answering
                        document.querySelectorAll('input[name="answer"]').forEach((input) => {
                          input.disabled = true;
                        });
                      }

                      function updateNavigationButtons() {
          const prevBtn = document.getElementById("prev-btn");
          const nextBtn = document.getElementById("next-btn");

          prevBtn.disabled = currentQuestionIndex === 0;

          // Ki·ªÉm tra xem ƒë√£ ƒë·∫øn c√¢u h·ªèi cu·ªëi ch∆∞a
          if (currentQuestionIndex === questions.length - 1) {
              nextBtn.textContent = "Complete";
              nextBtn.removeEventListener("click", nextQuestion);
              nextBtn.addEventListener("click", completeTest);
          } else {
              nextBtn.textContent = "Next";
              nextBtn.removeEventListener("click", completeTest);
              nextBtn.addEventListener("click", nextQuestion);
          }
      }

      function nextQuestion() {
          if (currentQuestionIndex < questions.length - 1) {
              currentQuestionIndex++;
              loadQuestion(currentQuestionIndex);

              // Reset tr·∫°ng th√°i c√¢u h·ªèi m·ªõi
              document.querySelectorAll('input[name="answer"]').forEach((input) => {
                  input.disabled = false;
                  input.checked = false;
              });
              document.getElementById("result").textContent = "";
          }
      }

      function prevQuestion() {
          if (currentQuestionIndex > 0) {
              currentQuestionIndex--;
              loadQuestion(currentQuestionIndex);

              // Reset tr·∫°ng th√°i c√¢u h·ªèi m·ªõi
              document.querySelectorAll('input[name="answer"]').forEach((input) => {
                  input.disabled = false;
                  input.checked = false;
              });
              document.getElementById("result").textContent = "";
          }
      }

                      function completeTest() {
                        const resultContainer = document.createElement("div");
                        resultContainer.classList.add("result-container");

                        resultContainer.innerHTML = `
                        <h2>Congratulations!</h2>
                        <p>You have completed the test.</p>
                        <div class="score">
                          <p>Total Questions: <span>${questions.length}</span></p>
                          <p>Correct Answers: <span>${correctCount}</span></p>
                          <p>Incorrect Answers: <span>${incorrectCount}</span></p>
                        </div>
                        <button onclick="window.location.reload()">Try Again</button>
                      `;

                        document.body.innerHTML = "";
                        document.body.appendChild(resultContainer);
                      }

                      function goBack() {
                        window.location.href = "/";
                      }

                      // Load first test automatically if available
                      window.onload = function () {
                        if (tests.length > 0) {
                          loadTest(tests[0].id);
                        }
                      };
                      /*]]>*/
    </script>
  </body>
</html>
